sudo: required
dist: focal
language: c
services:
  - postgresql
  - mysql
before_install:
  - git diff-index --quiet HEAD --
  - sudo apt-get remove -y mysql-server-8.0
  - sudo bash -c "echo deb http://repo.mysql.com/apt/ubuntu/ bionic mysql-5.7 >> /etc/apt/sources.list"
  - sudo apt-get update
  - sudo apt install -f "mysql-client=5.7"* "mysql-server=5.7*" "mysql-community-client=5.7*" "mysql-community-server=5.7*"
  - sudo apt-get install -y ocaml-nox ocaml-native-compilers opam python3-setuptools python3-pip libev-dev
  - pip3 install -U Sphinx
  - opam init --disable-sandboxing -n
  - opam switch create ocaml-base-compiler.4.08.0
  - eval `opam config env`
  - opam install conf-libev
  - opam install -y postgresql mysql ounit2
  - opam install -y ocamlformat.0.14.2
  - make rule-check
  - psql -c 'create database links;' -U postgres
  - mysql -e 'CREATE DATABASE links;'
  - mysql -e "CREATE USER links IDENTIFIED BY '12345';"
  - mysql -e 'GRANT ALL ON  links.* TO links;'
script:
  - ./opam2_local pin add links . -y
  - ./opam2_local pin add links-postgresql . -y
  - ./opam2_local pin add links-sqlite3 . -y
  - ./opam2_local pin add links-mysql . -y
  - make doc
  - make all-ci
  - make tests
  - ./run-database-tests tests/database -d all
  - ./run-database-tests tests/shredding -d all
  - ./run-database-tests tests/relational-lenses -d all
  - ./run-tests unit
addons:
  apt:
    # This has the same effect as running apt-get update, but avoid problems
    # with signature verification
    update: true
