sudo: required
dist: focal
language: c
services:
  - postgresql
  - mysql
before_install:
  - git diff-index --quiet HEAD --
  - sudo apt-get install -y ocaml-nox ocaml-native-compilers opam python3-setuptools python3-pip libev-dev
  - pip3 install -U Sphinx
  - opam init --disable-sandboxing -n
  - opam switch create ocaml-base-compiler.4.08.0
  - eval `opam config env`
  - opam install conf-libev
    # BEGIN Hack to install links-mysql
  - sudo apt install -y libmysqlclient-dev
  - opam install -y conf-mysql
  - sudo apt install -y libmariadb-dev
    # END
  - opam install -y postgresql mysql8 ounit2
  - opam install -y ocamlformat.0.14.2
  - make rule-check
  - psql -c 'create database links;' -U postgres
  - mysql -e 'CREATE DATABASE links;'
  - mysql -e "CREATE USER links IDENTIFIED BY '12345';"
  - mysql -e 'GRANT ALL ON  links.* TO links;'
script:
  - opam pin add links . -y
  - opam pin add links-postgresql . -y
  - opam pin add links-sqlite3 . -y
  - opam pin add links-mysql . -y
  - make doc
  - make all-ci
  - make tests
  - ./run-database-tests tests/database -d all
  - ./run-database-tests tests/shredding -d all
  - ./run-database-tests tests/relational-lenses -d all
  - ./run-tests unit
addons:
  apt:
    # This has the same effect as running apt-get update, but avoid problems
    # with signature verification
    update: true
