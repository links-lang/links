# Azure Pipelines configuration.

trigger:
- master

pr:
  autoCancel: true
  branches:
    include:
      - '*'  # must quote since "*" is a YAML reserved character.
pool:
  vmImage: 'ubuntu-16.04'

container: 
  image: ocaml/opam2:4.07
  options: "-u 0"

steps:
  - script: |
      printenv
    displayName: Environment

  - script: |
      cat >/tmp/opam  <<-EOF
        #!/bin/bash
        
        sudo -u opam /usr/bin/opam \$@
      EOF
      sudo chmod +x /tmp/opam
      sudo mv /tmp/opam /usr/local/bin/
      ls -lah /usr/bin/opam
      ls -lah /usr/local/bin/
      cat /usr/local/bin/opam
      /usr/local/bin/opam env
      whereis opam
    displayName: 'Setup environment'

  - script: |
      sudo apt-get install m4 -y
    displayName: 'System dependencies'

  - bash: |
      opam install ocamlformat -y
    displayName: 'Ocamlformat'

  - bash: |
      eval $(opam env)
      make rule-check
    displayName: 'Rule check'

  - bash: |
      case $AGENT_OS in
        "Linux") sudo apt-get install postgresql libpq-dev sqlite3 libsqlite3-dev -y &&
                 sudo LINKS_CI=1 tools/configure-postgresql &&
                 sudo service postgresql reload &&
                 sudo -u postgres createuser -s $(whoami) &&
                 sudo -u postgres createdb -O $(whoami) links ;;
        "Darwin") brew install postgresql libpq sqlite3 &&
                  pg_ctl -D /usr/local/var/postgres start &&
                  sleep 5 &&
                  /usr/local/opt/postgres/bin/createdb -O $(whoami) links ;;
        *) exit 1 ;;
      esac
    displayName: 'Databases'

  - bash: |
      eval $(opam env)
      opam pin add links . -y
      opam pin add links-postgresql . -y
      opam pin add links-sqlite3 . -y
    displayName: 'Links dependencies'

  - script: |
      eval $(opam env)
      make all-release
    displayName: 'Build Links (release)'

  - script: |
      eval $(opam env)
      make tests
    displayName: 'Server-side tests'

  - script: |
      eval $(opam env)
      ./run-tests db-only shredding
    displayName: 'Database shredding tests'

  - script: |
      eval $(opam env)
      ./run-tests db-only relational-lenses
    displayName: 'Relational lenses tests'

  - script: |
      eval $(opam env)
      opam install -y oUnit
      ./run-tests unit
    displayName: 'Unit tests'
